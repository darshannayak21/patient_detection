import platform
import time
import numpy as np
from PIL import Image, ImageDraw, ImageFont
import tflite_runtime.interpreter as tflite
import pygame

# --- Configuration ---
MODEL_PATH = "ssd_mobilenet_v2.tflite"
PATIENCE_SECONDS = 300  # 5 minutes absence threshold
CONFIDENCE_THRESHOLD = 0.55
PERSON_CLASS_ID = 0  # In most TFLite COCO models, 0 is 'person'. Change to 1 if using a custom model.

# --- Hardware Detection ---
def is_raspberry_pi():
    machine = platform.machine().lower()
    return 'arm' in machine or 'aarch64' in machine

# --- Camera Abstraction ---
class PiCam:
    def __init__(self):
        from picamera2 import Picamera2
        self.picam2 = Picamera2()
        # Optimize for real-time inference over high-res photography
        config = self.picam2.create_video_configuration(main={"format": "RGB888", "size": (640, 480)})
        self.picam2.configure(config)
        self.picam2.start()
        
    def get_frame(self):
        arr = self.picam2.capture_array()
        return Image.fromarray(arr)

    def close(self):
        self.picam2.stop()

class PygameCam:
    def __init__(self):
        pygame.camera.init()
        cameras = pygame.camera.list_cameras()
        if not cameras:
            raise Exception("No webcams found!")
        self.cam = pygame.camera.Camera(cameras[0], (640, 480))
        self.cam.start()

    def get_frame(self):
        img = self.cam.get_image()
        str_img = pygame.image.tostring(img, "RGB", False)
        return Image.frombytes("RGB", img.get_size(), str_img)

    def close(self):
        self.cam.stop()

# --- Main Engine ---
def main():
    # Initialize Pygame for cross-platform GUI
    pygame.init()
    screen = pygame.display.set_mode((640, 480))
    pygame.display.set_caption("AI Bedside Monitor")
    font = ImageFont.load_default()

    # Hardware routing
    if is_raspberry_pi():
        print("ARM Architecture Detected: Initializing Picamera2...")
        camera = PiCam()
    else:
        print("x86 Architecture Detected: Initializing Pygame Camera...")
        camera = PygameCam()

    # Load Intelligence Engine
    print("Loading TFLite Model...")
    interpreter = tflite.Interpreter(model_path=MODEL_PATH)
    interpreter.allocate_tensors()
    input_details = interpreter.get_input_details()
    output_details = interpreter.get_output_details()
    
    height = input_details[0]['shape'][1]
    width = input_details[0]['shape'][2]
    floating_model = (input_details[0]['dtype'] == np.float32)

    absence_start = 0

    print("System Online. Monitoring Bedside...")
    running = True
    while running:
        # Handle GUI closure
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                running = False
        
        # 1. Capture 
        pil_image = camera.get_frame()
        orig_width, orig_height = pil_image.size
        
        # 2. Preprocess Frame for TFLite
        resized_image = pil_image.resize((width, height))
        input_data = np.expand_dims(resized_image, axis=0)
        if floating_model:
            input_data = (np.float32(input_data) - 127.5) / 127.5
        else:
            input_data = np.uint8(input_data)

        # 3. Execute Inference
        interpreter.set_tensor(input_details[0]['index'], input_data)
        interpreter.invoke()

        # 4. Extract Bounding Boxes & Confidence
        boxes = interpreter.get_tensor(output_details[0]['index'])[0]
        classes = interpreter.get_tensor(output_details[1]['index'])[0]
        scores = interpreter.get_tensor(output_details[2]['index'])[0]

        draw = ImageDraw.Draw(pil_image)
        person_detected = False

        # Parse detections
        for i in range(len(scores)):
            if scores[i] > CONFIDENCE_THRESHOLD and int(classes[i]) == PERSON_CLASS_ID:
                person_detected = True
                ymin, xmin, ymax, xmax = boxes[i]
                
                # Project coordinates back to original camera resolution
                left, right = int(xmin * orig_width), int(xmax * orig_width)
                top, bottom = int(ymin * orig_height), int(ymax * orig_height)
                
                draw.rectangle([left, top, right, bottom], outline="lime", width=4)
                draw.text((left, top - 15), f"Patient: {int(scores[i]*100)}%", fill="lime", font=font)
                break # Only need to track one person for bedside monitor

        # 5. Timer & Alert Logic
        if person_detected:
            absence_start = 0 
        else:
            if absence_start == 0:
                absence_start = time.time()
            
            elapsed = time.time() - absence_start
            draw.text((10, 10), f"WARNING: Target Lost ({int(elapsed)}s)", fill="orange", font=font)
            
            if elapsed > PATIENCE_SECONDS:
                # 5-Minute Trigger
                draw.rectangle([0, 0, orig_width, orig_height], outline="red", width=15)
                draw.text((20, 40), "ALERT: BED EMPTY FOR 5 MINUTES", fill="red", font=font)
                
                # TRIGGER EXTERNAL SYSTEMS HERE (e.g., API call to nurse station)

        # 6. Render to Display
        mode = pil_image.mode
        size = pil_image.size
        data = pil_image.tobytes()
        py_image = pygame.image.fromstring(data, size, mode)
        
        screen.blit(py_image, (0, 0))
        pygame.display.flip()

    # Graceful exit
    camera.close()
    pygame.quit()

if __name__ == "__main__":
    main()